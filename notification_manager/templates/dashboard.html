{% extends "base.html" %}

{% block title %}ä»ªè¡¨æ¿ - é€šçŸ¥ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-speedometer2"></i> ä»ªè¡¨æ¿</h1>
</div>

<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card stats-card text-white h-100">
            <div class="card-body d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="bi bi-gear-fill" style="font-size: 2.5rem;"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-white-50">é…ç½®çš„å¹³å°</div>
                    <div class="h3 mb-0">{{ platforms|length }}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stats-card-success text-white h-100">
            <div class="card-body d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="bi bi-check-circle-fill" style="font-size: 2.5rem;"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-white-50">æˆåŠŸå‘é€</div>
                    <div class="h3 mb-0">{{ logs|selectattr('status', 'equalto', 'success')|list|length }}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stats-card-warning text-white h-100">
            <div class="card-body d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="bi bi-x-circle-fill" style="font-size: 2.5rem;"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-white-50">å‘é€å¤±è´¥</div>
                    <div class="h3 mb-0">{{ logs|selectattr('status', 'equalto', 'failed')|list|length }}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stats-card-info text-white h-100">
            <div class="card-body d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="bi bi-clock-fill" style="font-size: 2.5rem;"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="small text-white-50">æ€»å‘é€æ¬¡æ•°</div>
                    <div class="h3 mb-0">{{ logs|length }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-gear"></i> æˆ‘çš„å¹³å°</h5>
            </div>
            <div class="card-body">
                {% if platforms %}
                    {% for platform in platforms %}
                    <div class="d-flex align-items-center mb-3 p-3 bg-light rounded">
                        <div class="platform-icon {{ 'feishu-icon' if platform.platform_type == 'feishu' else 'flomo-icon' }}">
                            {% if platform.platform_type == 'feishu' %}
                                <i class="bi bi-chat-dots"></i>
                            {% elif platform.platform_type == 'flomo' %}
                                <i class="bi bi-journal"></i>
                            {% else %}
                                <i class="bi bi-gear"></i>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">{{ platform.name }}</h6>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-{{ 'success' if platform.is_active else 'secondary' }} me-2">
                                    {{ 'å¯ç”¨' if platform.is_active else 'ç¦ç”¨' }}
                                </span>
                                <small class="text-muted">{{ platform.platform_type }}</small>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success" onclick="testPlatform({{ platform.id }})" title="æµ‹è¯•è¿æ¥">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <a href="{{ url_for('edit_platform', platform_id=platform.id) }}" class="btn btn-sm btn-outline-primary" title="ç¼–è¾‘">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-gear text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-2">è¿˜æ²¡æœ‰é…ç½®ä»»ä½•å¹³å°</p>
                        <a href="{{ url_for('add_platform') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> æ·»åŠ ç¬¬ä¸€ä¸ªå¹³å°
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> æœ€è¿‘å‘é€è®°å½•</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span></span>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
                
                <div id="logsContainer">
                    {% if logs %}
                        {% for log in logs %}
                        <div class="d-flex justify-content-between align-items-start mb-2 log-item" data-status="{{ log.status }}">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-{{ 'check-circle-fill text-success' if log.status == 'success' else 'x-circle-fill text-danger' }}"></i>
                                    <small class="ms-2 text-muted">{{ log.sent_at.strftime('%m-%d %H:%M') }}</small>
                                    <span class="badge bg-{{ 'success' if log.status == 'success' else 'danger' }} ms-2">
                                        {{ 'æˆåŠŸ' if log.status == 'success' else 'å¤±è´¥' }}
                                    </span>
                                </div>
                                <div class="mt-1">
                                    <small>{{ log.message[:50] }}{% if log.message|length > 50 %}...{% endif %}</small>
                                    {% if log.error_message %}
                                    <div class="text-danger small mt-1">
                                        <i class="bi bi-exclamation-triangle"></i> {{ log.error_message[:100] }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if not loop.last %}<hr>{% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2">æš‚æ— å‘é€è®°å½•</p>
                            <small class="text-muted">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯åè¿™é‡Œä¼šæ˜¾ç¤ºè®°å½•</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-code-slash"></i> API ä½¿ç”¨è¯´æ˜</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>æ¨èä½¿ç”¨API Tokenè®¤è¯</strong> - æ›´å®‰å…¨çš„ä¼ä¸šçº§è®¤è¯æ–¹å¼
                    <a href="{{ url_for('api_token_page') }}" class="btn btn-sm btn-primary ms-2">
                        <i class="bi bi-key me-1"></i>ç®¡ç†Token
                    </a>
                </div>
                
                <h6><i class="bi bi-shield-check text-success me-2"></i>Headerè®¤è¯ï¼ˆæ¨èï¼‰</h6>
                <pre><code>POST /api/send
Authorization: Bearer YOUR_API_TOKEN
Content-Type: application/json

{
    "message": "ä½ çš„é€šçŸ¥å†…å®¹",
    "platform": "å¹³å°åç§°ï¼ˆå¯é€‰ï¼‰"
}</code></pre>

                <h6 class="mt-4"><i class="bi bi-code-square text-primary me-2"></i>JSON Bodyè®¤è¯ï¼ˆå…¼å®¹ï¼‰</h6>
                <pre><code>POST /api/send
Content-Type: application/json

{
    "token": "YOUR_API_TOKEN",
    "message": "ä½ çš„é€šçŸ¥å†…å®¹",
    "platform": "å¹³å°åç§°ï¼ˆå¯é€‰ï¼‰"
}</code></pre>

                <p class="mt-3"><strong>ç¤ºä¾‹ï¼š</strong></p>
                <pre><code># ä½¿ç”¨Headerè®¤è¯ï¼ˆæ¨èï¼‰
curl -X POST \
     -H "Authorization: Bearer YOUR_API_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"message":"æµ‹è¯•é€šçŸ¥ ğŸš€"}' \
     http://localhost:5555/api/send

# ä½¿ç”¨JSON Bodyè®¤è¯ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
curl -X POST \
     -H "Content-Type: application/json" \
     -d '{"token":"YOUR_API_TOKEN","message":"æµ‹è¯•é€šçŸ¥ ğŸ§â€â™‚ï¸"}' \
     http://localhost:5555/api/send</code></pre>

                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <small>è¯·å°† <code>YOUR_API_TOKEN</code> æ›¿æ¢ä¸ºä½ çš„å®é™…API Token</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testPlatform(platformId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    button.innerHTML = '<span class="loading-spinner me-1"></span>æµ‹è¯•ä¸­...';
    button.disabled = true;
    
    fetch('/test_platform/' + platformId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.success) {
            showToast('æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸï¼', 'success');
        } else {
            showToast('æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥ï¼š' + data.response, 'error');
        }
    })
    .catch(error => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('å‘é€å¤±è´¥ï¼š' + error, 'error');
    });
}

function refreshLogs() {
    const container = document.getElementById('logsContainer');
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    button.innerHTML = '<span class="loading-spinner me-1"></span>åˆ·æ–°ä¸­...';
    button.disabled = true;
    
    fetch('/api/recent_logs')
        .then(response => response.json())
        .then(data => {
            // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
            if (data.logs && data.logs.length > 0) {
                let html = '';
                data.logs.forEach((log, index) => {
                    const statusIcon = log.status === 'success' ? 'check-circle-fill text-success' : 'x-circle-fill text-danger';
                    const statusBadge = log.status === 'success' ? 'success' : 'danger';
                    const statusText = log.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                    
                    html += `
                        <div class="d-flex justify-content-between align-items-start mb-2 log-item" data-status="${log.status}">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-${statusIcon}"></i>
                                    <small class="ms-2 text-muted">${log.sent_at}</small>
                                    <span class="badge bg-${statusBadge} ms-2">${statusText}</span>
                                </div>
                                <div class="mt-1">
                                    <small>${log.message.length > 50 ? log.message.substring(0, 50) + '...' : log.message}</small>
                                    ${log.error_message ? `<div class="text-danger small mt-1"><i class="bi bi-exclamation-triangle"></i> ${log.error_message.substring(0, 100)}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        ${index < data.logs.length - 1 ? '<hr>' : ''}
                    `;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mt-2">æš‚æ— å‘é€è®°å½•</p>
                        <small class="text-muted">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯åè¿™é‡Œä¼šæ˜¾ç¤ºè®°å½•</small>
                    </div>
                `;
            }
            
            showToast('å‘é€è®°å½•å·²åˆ·æ–°', 'success');
        })
        .catch(error => {
            console.error('åˆ·æ–°å¤±è´¥:', error);
            showToast('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
}

function showToast(message, type = 'info') {
    // åˆ›å»º toast å…ƒç´ 
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // è‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ åŠ¨ç”»
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}平台管理 - 通知管理系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-gear"></i> 平台管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('add_platform') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 添加平台
        </a>
    </div>
</div>

{% if platforms %}
<div class="row g-4">
    {% for platform in platforms %}
    <div class="col-lg-6 col-xl-4">
        <div class="card h-100 notification-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="platform-icon {% if platform.platform_type == 'feishu' %}feishu-icon{% elif platform.platform_type == 'dingtalk' %}dingtalk-icon{% elif platform.platform_type == 'wework' %}wework-icon{% elif platform.platform_type == 'telegram' %}telegram-icon{% elif platform.platform_type == 'email' %}email-icon{% elif platform.platform_type == 'flomo' %}flomo-icon{% else %}webhook-icon{% endif %}">
                        {% if platform.platform_type == 'feishu' %}
                            <i class="bi bi-chat-dots"></i>
                        {% elif platform.platform_type == 'dingtalk' %}
                            <i class="bi bi-chat-square-dots"></i>
                        {% elif platform.platform_type == 'wework' %}
                            <i class="bi bi-wechat"></i>
                        {% elif platform.platform_type == 'telegram' %}
                            <i class="bi bi-telegram"></i>
                        {% elif platform.platform_type == 'email' %}
                            <i class="bi bi-envelope"></i>
                        {% elif platform.platform_type == 'flomo' %}
                            <i class="bi bi-journal"></i>
                        {% else %}
                            <i class="bi bi-globe"></i>
                        {% endif %}
                    </div>
                    <div class="ms-3 flex-grow-1">
                        <h5 class="card-title mb-1">{{ platform.name }}</h5>
                        <span class="badge bg-{{ 'success' if platform.is_active else 'secondary' }}">
                            {{ '启用' if platform.is_active else '禁用' }}
                        </span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-tag text-muted me-2"></i>
                        <span class="text-muted small">平台类型</span>
                    </div>
                    <div class="ms-4">
                        {% if platform.platform_type == 'feishu' %}
                            <span class="badge bg-info">飞书 Feishu</span>
                        {% elif platform.platform_type == 'dingtalk' %}
                            <span class="badge bg-primary">钉钉 DingTalk</span>
                        {% elif platform.platform_type == 'wework' %}
                            <span class="badge bg-success">企业微信</span>
                        {% elif platform.platform_type == 'telegram' %}
                            <span class="badge bg-info">Telegram</span>
                        {% elif platform.platform_type == 'email' %}
                            <span class="badge bg-danger">邮件 Email</span>
                        {% elif platform.platform_type == 'flomo' %}
                            <span class="badge bg-warning">Flomo</span>
                        {% elif platform.platform_type == 'webhook' %}
                            <span class="badge bg-dark">Webhook</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ platform.platform_type }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-link text-muted me-2"></i>
                        <span class="text-muted small">Webhook URL</span>
                    </div>
                    <div class="ms-4">
                        <code class="small text-break">{{ platform.webhook_url[:60] }}{% if platform.webhook_url|length > 60 %}...{% endif %}</code>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-calendar text-muted me-2"></i>
                        <span class="text-muted small">创建时间</span>
                    </div>
                    <div class="ms-4">
                        <small class="text-muted">{{ platform.created_at.strftime('%Y年%m月%d日 %H:%M') }}</small>
                    </div>
                </div>
            </div>
            
            <div class="card-footer bg-transparent">
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="testPlatform({{ platform.id }})" title="测试连接">
                        <i class="bi bi-play-fill"></i> 测试
                    </button>
                    <a href="{{ url_for('edit_platform', platform_id=platform.id) }}" class="btn btn-outline-primary btn-sm" title="编辑平台">
                        <i class="bi bi-pencil"></i> 编辑
                    </a>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deletePlatform({{ platform.id }}, '{{ platform.name }}')" title="删除平台">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center mt-5">
    <i class="bi bi-gear" style="font-size: 4rem; color: #ccc;"></i>
    <h3 class="mt-3 text-muted">还没有配置任何平台</h3>
    <p class="text-muted">添加你的第一个通知平台开始使用</p>
    <a href="{{ url_for('add_platform') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle"></i> 添加平台
    </a>
</div>
{% endif %}

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除平台 "<span id="platformName"></span>" 吗？</p>
                <p class="text-danger"><small>此操作不可撤销！</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testPlatform(platformId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    // 显示加载状态
    button.innerHTML = '<span class="loading-spinner me-1"></span>测试中...';
    button.disabled = true;
    
    fetch('/test_platform/' + platformId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // 恢复按钮状态
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.success) {
            showToast('测试消息发送成功！', 'success');
        } else {
            showToast('测试消息发送失败：' + data.response, 'error');
        }
    })
    .catch(error => {
        // 恢复按钮状态
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('发送失败：' + error, 'error');
    });
}

function deletePlatform(platformId, platformName) {
    document.getElementById('platformName').textContent = platformName;
    document.getElementById('deleteForm').action = '/delete_platform/' + platformId;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function showToast(message, type = 'info') {
    // 创建 toast 元素
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // 自动移除
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// 页面加载完成后添加动画
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.notification-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150);
    });
});
</script>
{% endblock %}

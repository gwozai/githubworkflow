{% extends "base.html" %}

{% block title %}ç¼–è¾‘æ¨¡æ¿ - é€šçŸ¥ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4"><i class="bi bi-pencil-square"></i> ç¼–è¾‘æ¶ˆæ¯æ¨¡æ¿</h1>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-gear"></i> ç¼–è¾‘æ¨¡æ¿
                </div>
                <div class="card-body">
                    <p class="text-muted">ä¿®æ”¹æ¨¡æ¿ä¿¡æ¯å’Œå†…å®¹</p>
                </div>
                
                <div class="card-body">
                    <form method="POST" id="editTemplateForm" onsubmit="return submitForm()">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="name" class="form-label">æ¨¡æ¿åç§° *</label>
                                    <input type="text" class="form-control" id="name" name="name" 
                                           value="{{ template.name }}" placeholder="ä¾‹å¦‚ï¼šè®¢å•å‘è´§é€šçŸ¥" required>
                                    <div class="form-text">ç»™æ¨¡æ¿èµ·ä¸€ä¸ªå®¹æ˜“è¯†åˆ«çš„åç§°</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="category" class="form-label">åˆ†ç±»</label>
                                    <select class="form-select" id="category" name="category">
                                        <option value="custom" {{ 'selected' if template.category == 'custom' }}>è‡ªå®šä¹‰</option>
                                        <option value="system" {{ 'selected' if template.category == 'system' }}>ç³»ç»Ÿé€šçŸ¥</option>
                                        <option value="marketing" {{ 'selected' if template.category == 'marketing' }}>è¥é”€æ¨å¹¿</option>
                                        <option value="alert" {{ 'selected' if template.category == 'alert' }}>å‘Šè­¦æé†’</option>
                                        <option value="report" {{ 'selected' if template.category == 'report' }}>æŠ¥å‘Šæ±‡æ€»</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">æ¨¡æ¿æè¿°</label>
                            <textarea class="form-control" id="description" name="description" rows="2" 
                                      placeholder="ç®€å•æè¿°è¿™ä¸ªæ¨¡æ¿çš„ç”¨é€”">{{ template.description }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="content" class="form-label">æ¨¡æ¿å†…å®¹ *</label>
                            <textarea class="form-control" id="content" name="content" rows="6" 
                                      placeholder="è¾“å…¥æ¶ˆæ¯æ¨¡æ¿å†…å®¹ï¼Œä½¿ç”¨ {{å˜é‡å}} æ¥å®šä¹‰å˜é‡" 
                                      required onkeyup="updatePreview()">{{ template.content }}</textarea>
                            <div class="form-text">
                                <strong>å˜é‡ä½¿ç”¨è¯´æ˜ï¼š</strong>ä½¿ç”¨ <code>{{å˜é‡å}}</code> æ¥å®šä¹‰å˜é‡ï¼Œå‘é€æ—¶å¯ä»¥åŠ¨æ€æ›¿æ¢
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">å˜é‡å®šä¹‰</label>
                            <div id="variablesContainer">
                                {% if template.variables %}
                                    {% set variables = template.variables | from_json %}
                                    {% for variable in variables %}
                                    <div class="row mb-2 variable-row">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control variable-name" 
                                                   name="variable_name[]" value="{{ variable.name }}" placeholder="å˜é‡å">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" 
                                                   name="variable_description[]" value="{{ variable.description }}" placeholder="å˜é‡æè¿°ï¼ˆå¯é€‰ï¼‰">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeVariable(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addVariable()">
                                <i class="bi bi-plus"></i> æ·»åŠ å˜é‡
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h6><i class="bi bi-eye"></i> å®æ—¶é¢„è§ˆ</h6>
                            <div class="border rounded p-3 bg-light" id="preview">
                                {{ template.content }}
                            </div>
                        </div>
                        
                        <!-- éšè—çš„å˜é‡æ•°æ®å­—æ®µ -->
                        <input type="hidden" name="variables" id="variablesData" value="">
                        
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('templates') }}" class="btn btn-secondary">å–æ¶ˆ</a>
                            <button type="button" class="btn btn-info" onclick="previewTemplate()">é¢„è§ˆæ•ˆæœ</button>
                            <button type="submit" class="btn btn-primary">ä¿å­˜æ¨¡æ¿</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <i class="bi bi-lightbulb"></i> æ¨¡æ¿ç¤ºä¾‹
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>è®¢å•é€šçŸ¥æ¨¡æ¿</h6>
                        <code class="d-block p-2 bg-light rounded small">
ä½ å¥½ {{name}}ï¼<br>
ä½ çš„è®¢å• {{order_id}} å·²ç»å‘è´§ï¼Œé¢„è®¡ {{delivery_date}} é€è¾¾ã€‚<br>
ç‰©æµå•å·ï¼š{{tracking_number}}<br>
æ”¶è´§åœ°å€ï¼š{{address}}<br>
æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼
                        </code>
                    </div>
                    
                    <div class="mb-3">
                        <h6>ç³»ç»Ÿå‘Šè­¦æ¨¡æ¿</h6>
                        <code class="d-block p-2 bg-light rounded small">
ğŸš¨ ç³»ç»Ÿå‘Šè­¦<br>
æœåŠ¡å™¨ï¼š{{server_name}}<br>
å‘Šè­¦ç±»å‹ï¼š{{alert_type}}<br>
å‘Šè­¦æ—¶é—´ï¼š{{alert_time}}<br>
è¯¦ç»†ä¿¡æ¯ï¼š{{details}}<br>
è¯·åŠæ—¶å¤„ç†ï¼
                        </code>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mt-3">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> ä½¿ç”¨ç»Ÿè®¡
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h4 text-primary">{{ template.usage_count }}</div>
                            <div class="small text-muted">ä½¿ç”¨æ¬¡æ•°</div>
                        </div>
                        <div class="col-6">
                            <div class="h4 text-success">{{ template.created_at.strftime('%m-%d') }}</div>
                            <div class="small text-muted">åˆ›å»ºæ—¥æœŸ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ¨¡æ¿é¢„è§ˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">æ¨¡æ¿å†…å®¹</label>
                    <div class="border rounded p-3 bg-light" id="previewContent"></div>
                </div>
                <div id="previewVariables"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addVariable() {
    const container = document.getElementById('variablesContainer');
    const div = document.createElement('div');
    div.className = 'row mb-2 variable-row';
    div.innerHTML = `
        <div class="col-md-4">
            <input type="text" class="form-control variable-name" name="variable_name[]" placeholder="å˜é‡å">
        </div>
        <div class="col-md-6">
            <input type="text" class="form-control" name="variable_description[]" placeholder="å˜é‡æè¿°ï¼ˆå¯é€‰ï¼‰">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeVariable(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(div);
}

function removeVariable(button) {
    button.closest('.variable-row').remove();
    updatePreview();
}

function updatePreview() {
    const content = document.getElementById('content').value;
    const preview = document.getElementById('preview');
    
    if (content) {
        // ç®€å•çš„å˜é‡æ›¿æ¢é¢„è§ˆ
        let previewContent = content;
        document.querySelectorAll('.variable-name').forEach(input => {
            if (input.value) {
                const regex = new RegExp('{{' + input.value + '}}', 'g');
                previewContent = previewContent.replace(regex, '[' + input.value + ']');
            }
        });
        preview.innerHTML = previewContent.replace(/\n/g, '<br>');
    } else {
        preview.textContent = 'è¯·è¾“å…¥æ¨¡æ¿å†…å®¹...';
    }
}

function previewTemplate() {
    const content = document.getElementById('content').value;
    if (!content) {
        alert('è¯·å…ˆè¾“å…¥æ¨¡æ¿å†…å®¹');
        return;
    }
    
    document.getElementById('previewContent').innerHTML = content.replace(/\n/g, '<br>');
    
    // æ˜¾ç¤ºå˜é‡åˆ—è¡¨
    const variables = [];
    document.querySelectorAll('.variable-name').forEach((input, index) => {
        if (input.value) {
            const description = document.querySelectorAll('input[name="variable_description[]"]')[index]?.value || '';
            variables.push({name: input.value, description: description});
        }
    });
    
    const variablesContainer = document.getElementById('previewVariables');
    if (variables.length > 0) {
        let html = '<label class="form-label">å˜é‡åˆ—è¡¨</label><ul class="list-group">';
        variables.forEach(variable => {
            html += '<li class="list-group-item d-flex justify-content-between">' +
                '<span><code>{{' + variable.name + '}}</code></span>' +
                '<small class="text-muted">' + variable.description + '</small>' +
            '</li>';
        });
        html += '</ul>';
        variablesContainer.innerHTML = html;
    } else {
        variablesContainer.innerHTML = '<p class="text-muted">æ­¤æ¨¡æ¿æ²¡æœ‰å®šä¹‰å˜é‡</p>';
    }
    
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function submitForm() {
    // æ”¶é›†å˜é‡æ•°æ®
    const variables = [];
    document.querySelectorAll('.variable-name').forEach((input, index) => {
        if (input.value) {
            const description = document.querySelectorAll('input[name="variable_description[]"]')[index]?.value || '';
            variables.push({
                name: input.value,
                description: description
            });
        }
    });
    
    // å°†å˜é‡æ•°æ®è½¬æ¢ä¸ºJSONå¹¶è®¾ç½®åˆ°éšè—å­—æ®µ
    document.getElementById('variablesData').value = JSON.stringify(variables);
    
    return true; // å…è®¸è¡¨å•æäº¤
}

// é¡µé¢åŠ è½½æ—¶æ›´æ–°é¢„è§ˆ
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>
{% endblock %}

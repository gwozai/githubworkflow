{% extends "base.html" %}

{% block title %}åˆ›å»ºæ¨¡æ¿ - é€šçŸ¥ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-plus-circle"></i> åˆ›å»ºæ¶ˆæ¯æ¨¡æ¿</h1>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-transparent border-0 pt-4 pb-0">
                <div class="text-center">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary bg-gradient mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-file-text text-white" style="font-size: 1.5rem;"></i>
                    </div>
                    <h4 class="fw-bold">åˆ›å»ºæ¶ˆæ¯æ¨¡æ¿</h4>
                    <p class="text-muted">åˆ›å»ºå¯å¤ç”¨çš„æ¶ˆæ¯æ¨¡æ¿ï¼Œæé«˜å‘é€æ•ˆç‡</p>
                </div>
            </div>
            <div class="card-body px-4 pb-4">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="name" class="form-label">æ¨¡æ¿åç§° *</label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="ä¾‹å¦‚ï¼šè®¢å•å‘è´§é€šçŸ¥">
                                <div class="form-text">ç»™æ¨¡æ¿èµ·ä¸€ä¸ªå®¹æ˜“è¯†åˆ«çš„åç§°</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="category" class="form-label">åˆ†ç±»</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="custom">è‡ªå®šä¹‰</option>
                                    <option value="notification">ç³»ç»Ÿé€šçŸ¥</option>
                                    <option value="marketing">è¥é”€æ¨å¹¿</option>
                                    <option value="alert">å‘Šè­¦æé†’</option>
                                    <option value="report">æŠ¥å‘Šæ±‡æ€»</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">æ¨¡æ¿æè¿°</label>
                        <input type="text" class="form-control" id="description" name="description" 
                               placeholder="ç®€å•æè¿°è¿™ä¸ªæ¨¡æ¿çš„ç”¨é€”">
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">æ¨¡æ¿å†…å®¹ *</label>
                        <textarea class="form-control" id="content" name="content" rows="6" required 
                                  placeholder="è¾“å…¥æ¶ˆæ¯æ¨¡æ¿å†…å®¹ï¼Œä½¿ç”¨ {{å˜é‡å}} æ¥å®šä¹‰å˜é‡"></textarea>
                        <div class="form-text">
                            <strong>å˜é‡ä½¿ç”¨è¯´æ˜ï¼š</strong> ä½¿ç”¨ <code>{{å˜é‡å}}</code> æ¥å®šä¹‰å˜é‡ï¼Œå‘é€æ—¶å¯ä»¥åŠ¨æ€æ›¿æ¢
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">å˜é‡å®šä¹‰</label>
                        <div id="variablesContainer">
                            <!-- åŠ¨æ€æ·»åŠ çš„å˜é‡å®šä¹‰ -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addVariable()">
                            <i class="bi bi-plus"></i> æ·»åŠ å˜é‡
                        </button>
                        <input type="hidden" id="variables" name="variables" value="[]">
                    </div>
                    
                    <div class="mb-4">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-eye"></i> å®æ—¶é¢„è§ˆ</h6>
                            </div>
                            <div class="card-body">
                                <div id="preview" class="text-muted">è¯·è¾“å…¥æ¨¡æ¿å†…å®¹...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('templates') }}" class="btn btn-secondary">å–æ¶ˆ</a>
                        <button type="button" class="btn btn-outline-primary" onclick="previewTemplate()">é¢„è§ˆæ•ˆæœ</button>
                        <button type="submit" class="btn btn-primary">åˆ›å»ºæ¨¡æ¿</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-lightbulb"></i> æ¨¡æ¿ç¤ºä¾‹</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>è®¢å•é€šçŸ¥æ¨¡æ¿</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <code>ä½ å¥½ {{customer_name}}ï¼<br><br>
ä½ çš„è®¢å• {{order_id}} å·²ç»å‘è´§ï¼Œé¢„è®¡ {{delivery_date}} é€è¾¾ã€‚<br><br>
ç‰©æµå•å·ï¼š{{tracking_number}}<br>
æ”¶è´§åœ°å€ï¼š{{address}}<br><br>
æ„Ÿè°¢æ‚¨çš„è´­ä¹°ï¼</code>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ç³»ç»Ÿå‘Šè­¦æ¨¡æ¿</h6>
                        <div class="bg-light p-3 rounded mb-3">
                            <code>ğŸš¨ ç³»ç»Ÿå‘Šè­¦<br><br>
æœåŠ¡å™¨ï¼š{{server_name}}<br>
å‘Šè­¦ç±»å‹ï¼š{{alert_type}}<br>
å‘Šè­¦æ—¶é—´ï¼š{{alert_time}}<br>
è¯¦ç»†ä¿¡æ¯ï¼š{{details}}<br><br>
è¯·åŠæ—¶å¤„ç†ï¼</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let variableCount = 0;

function addVariable() {
    variableCount++;
    const container = document.getElementById('variablesContainer');
    const div = document.createElement('div');
    div.className = 'variable-item mb-2 p-3 border rounded';
    div.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm variable-name" 
                       placeholder="å˜é‡å" onchange="updateVariables()">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control form-control-sm variable-desc" 
                       placeholder="å˜é‡æè¿°ï¼ˆå¯é€‰ï¼‰" onchange="updateVariables()">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeVariable(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(div);
}

function removeVariable(button) {
    button.closest('.variable-item').remove();
    updateVariables();
}

function updateVariables() {
    const variables = [];
    document.querySelectorAll('.variable-item').forEach(item => {
        const name = item.querySelector('.variable-name').value;
        const description = item.querySelector('.variable-desc').value;
        if (name) {
            variables.push({
                name: name,
                description: description
            });
        }
    });
    document.getElementById('variables').value = JSON.stringify(variables);
    updatePreview();
}

function updatePreview() {
    const content = document.getElementById('content').value;
    const preview = document.getElementById('preview');
    
    if (content) {
        // ç®€å•çš„å˜é‡æ›¿æ¢é¢„è§ˆ
        let previewContent = content;
        document.querySelectorAll('.variable-name').forEach(input => {
            if (input.value) {
                const regex = new RegExp('{{' + input.value + '}}', 'g');
                previewContent = previewContent.replace(regex, '[' + input.value + ']');
            }
        });
        preview.innerHTML = previewContent.replace(/\n/g, '<br>');
    } else {
        preview.textContent = 'è¯·è¾“å…¥æ¨¡æ¿å†…å®¹...';
    }
}

function previewTemplate() {
    const content = document.getElementById('content').value;
    if (!content) {
        alert('è¯·å…ˆè¾“å…¥æ¨¡æ¿å†…å®¹');
        return;
    }
    
    // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ¨¡æ¿é¢„è§ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="bg-light p-3 rounded">
                        ${content.replace(/\n/g, '<br>')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // æ¨¡æ€æ¡†å…³é—­åç§»é™¤
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// ç›‘å¬å†…å®¹å˜åŒ–
document.getElementById('content').addEventListener('input', updatePreview);

// é¡µé¢åŠ è½½æ—¶çš„åŠ¨ç”»
document.addEventListener('DOMContentLoaded', function() {
    const card = document.querySelector('.card');
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    setTimeout(() => {
        card.style.transition = 'all 0.5s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
    }, 100);
});
</script>
{% endblock %}
